# VAD 模式调试分析报告

**报告编号**: VAD-DEBUG-20251214  
**分析员**: Antigravity (Google DeepMind Advanced Agentic Coding)  
**日期**: 2025年12月14日  
**日志文件**: `20251214214419_vad_log.txt`

---

## 一、核心发现

### 🚨 致命问题：VAD 概率值始终为固定常量

在整个约 **4分钟** 的录音过程中（08:44:19 - 08:48:45），VAD 检测的语音概率值 **始终为 0.0040**，从未变化过。

| 时间戳 | VAD概率 | 音频振幅 | 问题 |
|--------|---------|----------|------|
| 08:44:20.331Z | **0.0040** | 0.0268 | 概率不变 |
| 08:44:58.807Z | **0.0040** | 0.8627 | 高振幅，概率仍不变 |
| 08:45:01.332Z | **0.0040** | 1.0023 | 峰值振幅，概率仍不变 |
| 08:47:00.299Z | **0.0040** | 0.9591 | 极高振幅，概率仍不变 |
| 08:48:43.170Z | **0.0040** | 0.1258 | 结束时概率仍不变 |

**这是不正常的！** 真正的 VAD 模型应该根据音频内容动态输出 0.0 到 1.0 之间的概率值。

---

## 二、详细分析

### 2.1 音频数据流正常

从 `[AudioFlow]` 日志可以看出：
- ✅ 音频振幅范围合理：0.0010 ~ 1.0023
- ✅ Buffer 持续增长：从 0 增长到 2072
- ✅ 录音模式正确识别为 `Mode=vad`
- ✅ 音频数据在正常采集

### 2.2 VAD 检测完全失效

从 `[VAD-Detect]` 日志可以看出：
- ❌ `Prob=0.0040` 是一个**硬编码常量**或**默认返回值**
- ❌ 概率值与振幅完全无关联
- ❌ `isSpeaking` 始终为 `false`

### 2.3 切片逻辑永远无法触发

由于 `isSpeaking` 永远为 `false`：
```
[VAD-Event] Silence threshold met (262912ms) but not speaking, no cut.
```
- 静音阈值持续累积（从512ms增长到262912ms = 约4.4分钟）
- 因为"从未说话"(`not speaking`)，所以"无法切片"(`no cut`)
- 音频 Buffer 只增不减，永远不会发送到后端

---

## 三、问题根源定位

### 可能性 1：VAD 模型未正确加载（最可能）

`0.0040` 这个精确的固定值强烈暗示：
- VAD 模型（如 Silero VAD）未成功初始化
- 代码返回了一个默认/fallback值

### 可能性 2：音频数据格式不匹配

VAD 模型可能期望特定格式的音频数据：
- 采样率不匹配（模型期望 16kHz，实际可能是 48kHz）
- 数据类型错误（模型期望 Float32，实际传入其他格式）
- 通道数错误（模型期望单声道）

### 可能性 3：音频数据未正确传递给 VAD

从前端传递给 VAD 服务的音频数据可能：
- 是空数据或全零数据
- 传递路径断开
- 数据被意外覆盖

---

## 四、建议排查的代码位置

### 4.1 VAD 服务初始化
```
建议文件: src/services/vadService.ts 或类似
排查点: VAD 模型的加载、初始化逻辑
```

### 4.2 音频数据处理管道
```
建议文件: src/services/audioProcessingService.ts 或类似
排查点: 传递给 VAD 的音频 buffer 是否是正确的采集数据
```

### 4.3 VAD 概率计算函数
```
排查点: 返回 0.0040 的具体代码位置
方法: 全局搜索 "0.0040" 或 "0.004"
```

---

## 五、修复建议

### 优先级 1：确认 VAD 模型正常初始化
1. 添加模型加载成功/失败的日志
2. 检查模型文件路径是否正确
3. 验证 ONNX Runtime 或 tfjs 是否正常工作

### 优先级 2：验证音频数据格式
1. 在传入 VAD 前打印音频数据的前10个采样值
2. 确认采样率为 16000Hz
3. 确认数据类型为 Float32Array

### 优先级 3：添加 VAD 输入输出诊断日志
```javascript
// 建议添加的诊断日志
console.log('[VAD-Debug] Input buffer length:', buffer.length);
console.log('[VAD-Debug] Input buffer sample:', buffer.slice(0, 10));
console.log('[VAD-Debug] Raw model output:', rawOutput);
```

---

## 六、结论

| 项目 | 结论 |
|------|------|
| **问题性质** | VAD 模型未正确工作 |
| **核心证据** | 概率值固定为 0.0040，与音频内容完全无关 |
| **影响范围** | VAD 模式完全失效，无法实现智能切片 |
| **紧急程度** | 高 - 核心功能不可用 |
| **修复难度** | 中等 - 需要定位具体代码问题 |

---

## 七、依据总结

1. **348行日志全部显示 `Prob=0.0040`** - 概率值无变化
2. **音频振幅变化范围 0.001 ~ 1.002** - 证明音频采集正常
3. **`isSpeaking=false` 贯穿始终** - VAD 从未识别到语音
4. **静音时长累积到 262912ms** - 证明切片逻辑无法触发
5. **Buffer 持续增长** - 音频堆积但从未发送

---

*报告结束*

**Antigravity**  
*Google DeepMind Advanced Agentic Coding*
