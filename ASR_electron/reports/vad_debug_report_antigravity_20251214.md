# VAD 模式调试分析报告

**作者**: Antigravity (Google DeepMind)  
**日期**: 2025年12月14日  
**日志文件**: `20251214220553_vad_log.txt`

---

## 一、我的发现

### 1. VAD 概率值异常固定

| 观察 | 问题 |
|------|------|
| VAD 概率值 | **始终为 0.0040**，从未变化 |
| 音频振幅 | 正常波动，范围 0.001 ~ 1.07 |
| isSpeaking 状态 | **永远为 false** |
| 音频缓冲区 | 持续累积（0 → 1872），从未被切分/发送 |

### 2. 典型异常日志示例

```log
[VAD-Detect] Prob=0.0040 | Amp=1.0710   ← 振幅极高，概率却固定为 0.0040
[VAD-Detect] Prob=0.0040 | Amp=0.9940   ← 同一模式
[VAD-Detect] Prob=0.0040 | Amp=0.9833   ← 同一模式
```

即使在人声信号强度接近满量程时，VAD 模型返回的概率值依然是 `0.0040`，这是一个**明显的初始化值或默认返回值**。

### 3. 系统持续等待但从未触发

日志显示静默阈值不断累积：
```log
Silence threshold met (237312ms) but not speaking, no cut.
```

系统等待了超过 **237秒 (近4分钟)**，但因为 `isSpeaking` 始终为 `false`，所以从未进行音频切分和发送。

---

## 二、我的结论

> [!CAUTION]
> **VAD 模型没有正确接收或处理真实的音频数据。**

VAD 模块输出的概率值 `0.0040` 是一个固定常数，不随输入音频变化。这意味着存在以下可能性之一：

1. **音频数据未正确传入 VAD 模型** — 传递的可能是空数组、零数组、或格式错误的数据
2. **音频数据格式不匹配** — VAD 模型期望的输入格式与实际传入的格式不一致（如采样率、位深度、声道数）
3. **VAD 模型状态未正确初始化** — 模型可能处于某种初始化失败或静默状态

---

## 三、我认为哪里的代码有问题

基于日志分析，问题很可能出现在以下位置：

### 1. `funasrVAD.ts` — VAD 服务模块

- `processAudioChunk()` 方法：负责将音频数据送入 VAD 模型
- 需要检查传入模型的音频 buffer 是否为正确格式

### 2. `fbank.ts` — 音频特征提取模块

- 如果 VAD 模型依赖 fbank 特征，需要确认特征提取管道是否正常工作
- 检查特征矩阵的维度和数值范围是否符合模型预期

### 3. 音频数据流转换链路

```
麦克风 → AudioWorkletProcessor → Float32Array → [格式转换?] → VAD 模型
                                                    ↑
                                              可能的断点
```

需要验证从 `AudioWorkletProcessor` 输出的数据到 VAD 模型输入之间是否存在数据丢失或格式转换错误。

---

## 四、我的推荐

### 立即行动

1. **打印 VAD 模型的原始输入**
   - 在调用 VAD 推理前，打印传入的音频数据的前 10 个样本值
   - 确认数据不是全零或 NaN

2. **验证音频格式参数**
   ```typescript
   console.log('Sample Rate:', sampleRate);
   console.log('Buffer Size:', buffer.length);
   console.log('Buffer Type:', buffer.constructor.name);
   console.log('Sample Values:', buffer.slice(0, 10));
   ```

3. **对比 AudioFlow 日志的 Amp 值与 VAD 输入**
   - `AudioFlow` 日志显示振幅正常，说明原始音频数据是好的
   - 问题出在数据**传递到 VAD 模型的过程中**

### 中期修复

4. **检查 VAD 模型的初始化流程**
   - 确认模型文件加载成功
   - 确认推理 session 创建无误

5. **添加 VAD 输入输出的完整追踪日志**
   - 记录每次推理的输入数据特征（均值、最大值、长度）
   - 记录模型输出的原始张量值

---

## 五、我的依据

| 依据 | 说明 |
|------|------|
| 振幅数据正常 | `AudioFlow` 日志显示振幅在 0.001 到 1.07 之间正常波动，证明麦克风输入是正常的 |
| VAD 概率固定 | 整个录音过程中（近4分钟），`Prob` 始终为 `0.0040`，这在正常情况下是不可能的 |
| Buffer 持续累积 | 从 0 增长到 1872，说明系统在持续接收音频，但 VAD 判断始终为"静默" |
| 无切分事件 | 日志中没有出现任何 "speech detected" 或 "sending chunk" 类型的事件 |

---

## 六、日志数据统计

| 指标 | 值 |
|------|-----|
| 录音时长 | ~4分钟 (237秒+) |
| VAD 检测次数 | 47次 |
| VAD 概率范围 | 0.0040 (固定值) |
| 音频振幅范围 | 0.001 ~ 1.07 |
| 最大振幅出现时间 | 09:07:08 (Amp=1.0710) |
| isSpeaking=true 次数 | **0次** |
| 音频切分/发送次数 | **0次** |

---

**报告结束**

*Antigravity - Google DeepMind Advanced Agentic Coding*
