# VAD 功能开发状态与决策报告
**日期**: 2025-12-14
**状态**: ⏸️ 已暂停 (Paused)

## 1. 背景与问题
用户在测试 VAD (Voice Activity Detection) 模式时发现，系统始终无法检测到语音，表现为：
- VAD 概率值固定为 `0.0040`
- `isSpeaking` 状态始终为 `false`
- 无法触发音频自动切分和发送

## 2. 调试与发现
在调试过程中，我们发现并修复了以下问题：

### 2.1 幅度缩放问题 (已修复)
- **原因**: Web Audio API 输出的音频数据范围是 `[-1.0, 1.0]` (浮点)，而 FunASR 模型期望的是 `[-32768, 32767]` (16-bit 整数范围)。
- **结果**: 输入信号过于微弱，被模型视为绝对静音。
- **修复**: 在 `fbank.ts` 中增加了幅度缩放逻辑。

### 2.2 模型结构问题 (根本原因)
- **发现**: 即使修复了幅度，VAD 概率仍然异常。
- **深入分析**: 检查日志发现，项目使用的 `model.onnx` (FSMN-VAD) 输出维度为 `[1, N, 248]`。
- **结论**: 这是一个**不完整**的模型导出。它只包含 FSMN 编码器部分（输出 248 维隐藏状态），**缺少了最后的分类层**（Linear + Softmax -> 2维概率）。
- **影响**: 代码原本假设输出为 2 维 `[silence, speech]`，导致解析错误。由于缺少分类层，无法从该模型直接获取准确的语音概率。

## 3. 临时解决方案
由于原 ONNX 模型不可用，我们在 `useVADRecording.ts` 中实现了一个**基于振幅的临时 VAD**：
- **逻辑**: 直接使用音频平均振幅 (`avgAmp * 10`) 作为语音概率。
- **效果**: 
    - 成功解决了 "一直不说话" 的问题，可以触发 `isSpeaking=true`。
    - **缺点**: 缺乏语义理解，对噪音敏感，导致切分频率过高，体验不佳。

## 4. 决策与后续建议
**用户决定**: 鉴于当前方案（基于振幅）效果不理想，而修复模型需要引入新的高级模型资源，用户决定**暂时不想继续投入精力调试此功能**。

**后续建议**:
未来若需重启 VAD 优化，建议采取以下方案之一：
1. **更换引擎**: 使用 **Silero VAD**。这是一个专门为 Web 优化的 VAD 模型，标准且效果更好，只有单一输出（概率），集成简单。
2. **更新模型**: 寻找或导出包含分类头的完整 FunASR FSMN-VAD ONNX 模型。
3. **后端 VAD**: 将 VAD 逻辑移至服务器端处理（如果实时性要求允许）。
