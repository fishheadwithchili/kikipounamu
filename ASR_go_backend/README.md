# ASR Go Backend (é«˜å¹¶å‘è°ƒåº¦æœåŠ¡)

è¿™æ˜¯ä¸€ä¸ªåŸºäº Go è¯­è¨€å¼€å‘çš„é«˜æ€§èƒ½ ASRï¼ˆè¯­éŸ³è¯†åˆ«ï¼‰åç«¯è°ƒåº¦æœåŠ¡ã€‚å®ƒä½œä¸ºå‰ç«¯ä¸åº•å±‚ Python ASR æ¨ç†æœåŠ¡ä¹‹é—´çš„æ¡¥æ¢ï¼Œæä¾›å®æ—¶ WebSocket æµå¼å¤„ç†ã€ä»»åŠ¡å¹¶å‘è°ƒåº¦ä»¥åŠæ•°æ®æŒä¹…åŒ–åŠŸèƒ½ã€‚

## ğŸŒŸ æ ¸å¿ƒç‰¹æ€§

*   **âš¡ é«˜å¹¶å‘æ¶æ„**ï¼šå†…ç½® Goroutine Worker Poolï¼Œé«˜æ•ˆå¤„ç†å¹¶å‘éŸ³é¢‘åˆ†å—è¯·æ±‚ã€‚
*   **ğŸ“¡ å®æ—¶é€šä¿¡**ï¼šåŸºäº WebSocket çš„å…¨åŒå·¥é€šä¿¡ï¼Œæ”¯æŒæµå¼éŸ³é¢‘ä¸Šä¼ å’Œç»“æœæ¨é€ã€‚
*   **ğŸ—„ï¸ æ•°æ®æŒä¹…åŒ–**ï¼šé›†æˆ **PostgreSQL**ï¼Œå®Œæ•´è®°å½•ä¼šè¯å†å²ã€éŸ³é¢‘åˆ†å—è¯¦æƒ…å’Œè¯†åˆ«ç»“æœã€‚
*   **ğŸ›¡ï¸ å¥å£®æ€§è®¾è®¡**ï¼šæ”¯æŒä¼˜é›…å…³é—­ã€é”™è¯¯å¤„ç†å’Œè‡ªåŠ¨æ¢å¤ã€‚
*   **ğŸ”Œ æ˜“äºé›†æˆ**ï¼šæä¾› RESTful API ç”¨äºå†å²è®°å½•æŸ¥è¯¢å’Œä¼šè¯ç®¡ç†ã€‚

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

*   **è¯­è¨€**: Go 1.21+
*   **Web æ¡†æ¶**: Gin
*   **WebSocket**: Gorilla WebSocket
*   **æ•°æ®åº“**: PostgreSQL 14+ (pgx driver)
*   **é…ç½®ç®¡ç†**: ç¯å¢ƒå˜é‡

## ğŸš€ éƒ¨ç½²ä¸å¯åŠ¨

### 1. ç¯å¢ƒå‡†å¤‡

ç¡®ä¿æœåŠ¡å™¨å·²å®‰è£…ï¼š
*   **Go** (>= 1.21)
*   **PostgreSQL** (>= 14)

### 2. æ•°æ®åº“é…ç½®

åˆ›å»ºä¸€ä¸ªåä¸º `root` (æˆ–å…¶ä»–åç§°) çš„æ•°æ®åº“ï¼Œå¹¶ç¡®ä¿æœ‰ç”¨æˆ·æƒé™ã€‚

```bash
# ç¤ºä¾‹ï¼šåˆ›å»ºæ•°æ®åº“ï¼ˆå‘½ä»¤è¡Œï¼‰
createdb -U postgres root
```

*æ³¨æ„ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºæ‰€éœ€çš„ `asr_sessions` å’Œ `asr_chunks` è¡¨ã€‚*

### 3. å®‰è£…ä¾èµ–

```bash
go mod tidy
```

### 4. é…ç½®æ–‡ä»¶ (ç¯å¢ƒå˜é‡)

å¯ä»¥é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡æ¥é…ç½®æœåŠ¡ï¼š

| å˜é‡å | é»˜è®¤å€¼ | è¯´æ˜ |
| :--- | :--- | :--- |
| `PORT` | `8080` | æœåŠ¡ç›‘å¬ç«¯å£ |
| `FUNASR_ADDR` | `localhost:8000` | åº•å±‚ Python ASR_server åœ°å€ |
| `DB_HOST` | `localhost` | æ•°æ®åº“ä¸»æœº |
| `DB_PORT` | `5432` | æ•°æ®åº“ç«¯å£ |
| `DB_USER` | `root` | æ•°æ®åº“ç”¨æˆ·å |
| `DB_PASSWORD` | `123456` | æ•°æ®åº“å¯†ç  |
| `DB_NAME` | `root` | æ•°æ®åº“åç§° |

### 5. å¯åŠ¨æœåŠ¡

```bash
# 1. å¯åŠ¨ PostgreSQL æ•°æ®åº“
sudo service postgresql start

# 2. ç¡®ä¿æ•°æ®åº“å­˜åœ¨ (å¦‚æœæŠ¥é”™ exist åˆ™å¿½ç•¥)
sudo -u postgres createdb root

# 3. è®¾ç½®ç¯å¢ƒå˜é‡å¹¶å¯åŠ¨æœåŠ¡
export DB_USER=root
export DB_PASSWORD=123456
export DB_NAME=root

go run cmd/server/main.go
```

æˆ–è€…ç¼–è¯‘åè¿è¡Œï¼š

```bash
go build -o asr-backend cmd/server/main.go
./asr-backend
```

## ğŸ”Œ API æ¥å£æ–‡æ¡£

### 1. WebSocket (å®æ—¶è¯†åˆ«)

*   **URL**: `ws://<server_ip>:8080/ws/asr`
*   **åè®®**:
    *   **å®¢æˆ·ç«¯å‘é€**:
        *   `{"action": "start", "session_id": "uuid"}`: å¼€å§‹ä¼šè¯
        *   `{"action": "chunk", "session_id": "...", "chunk_index": 0, "audio_data": "base64..."}`: å‘é€éŸ³é¢‘å— (WebM/WAV)
        *   `{"action": "finish", "session_id": "..."}`: ç»“æŸä¼šè¯
    *   **æœåŠ¡ç«¯è¿”å›**:
        *   `{"type": "ack", "status": "session_started", ...}`
        *   `{"type": "chunk_result", "chunk_index": 0, "text": "è¯†åˆ«ç»“æœ"}`
        *   `{"type": "final_result", "text": "å®Œæ•´è¯†åˆ«ç»“æœ"}`

### 2. REST API (ç®¡ç†ä¸æŸ¥è¯¢)

*   `GET /api/v1/health`: å¥åº·æ£€æŸ¥ (åŒ…å« DBã€Redisã€AI æœåŠ¡çŠ¶æ€)
*   `GET /api/v1/history?limit=50`: è·å–æœ€è¿‘çš„å†å²ä¼šè¯
*   `GET /api/v1/session/:id`: è·å–ç‰¹å®šä¼šè¯è¯¦æƒ…
*   `DELETE /api/v1/session/:id`: åˆ é™¤ä¼šè¯
*   `GET /api/v1/stats`: è·å–æœåŠ¡ç»Ÿè®¡ (Proxy to AI Service)
*   `GET /api/v1/asr/queue/status`: è·å–é˜Ÿåˆ—çŠ¶æ€ (Proxy to AI Service)

## ğŸ“‚ ç›®å½•ç»“æ„

```
.
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ server/         # ç¨‹åºå…¥å£
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ config/         # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ db/             # æ•°æ®åº“æ“ä½œ (PostgreSQL)
â”‚   â”œâ”€â”€ handler/        # HTTP å’Œ WebSocket å¤„ç†
â”‚   â”œâ”€â”€ service/        # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (Session, ASRè°ƒåº¦)
â”‚   â””â”€â”€ model/          # æ•°æ®æ¨¡å‹
â””â”€â”€ go.mod
```
