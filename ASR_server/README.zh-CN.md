# ASR FastAPI å¾®æœåŠ¡

> **è¯­è¨€åˆ‡æ¢**: [English](README.md) | [ç®€ä½“ä¸­æ–‡](README.zh-CN.md)

åŸºäº FunASR çš„é«˜æ€§èƒ½è¯­éŸ³è¯†åˆ« REST API æœåŠ¡

## âœ¨ ç‰¹æ€§

- ğŸš€ **å¼‚æ­¥å¤„ç†** - Redis Streams é«˜å¹¶å‘ä»»åŠ¡é˜Ÿåˆ—
- ğŸ“¡ **RESTful API** - 9 ä¸ªå®Œæ•´çš„ API ç«¯ç‚¹
- ğŸ”¥ **é«˜æ€§èƒ½** - GPU åŠ é€Ÿï¼ŒRTF < 0.05
- ğŸ“Š **è‡ªåŠ¨ç®¡ç†** - æ–‡ä»¶è‡ªåŠ¨æ¸…ç†ï¼Œå†å²è®°å½•ç»´æŠ¤
- ğŸ“ **å®Œæ•´æ—¥å¿—** - åˆ†å±‚æ—¥å¿— + JSON Lines ä¸šåŠ¡æ—¥å¿—
- ğŸ§ª **æµ‹è¯•å®Œå¤‡** - å•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰æ¥å£

## ğŸ—ï¸ æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Redis (Streams + ç¼“å­˜)            â”‚
â”‚       ç«¯å£: 6379                        â”‚
â””â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚       â”‚
      â–¼       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FastAPI  â”‚ â”‚UniWorker â”‚ â”‚UniWorker â”‚
â”‚  :8000   â”‚ â”‚  (1)     â”‚ â”‚  (N)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸŒ åˆ†å¸ƒå¼ä¸åŠ¨æ€æ‰©å±•

æœ¬é¡¹ç›®å¤©ç”Ÿæ”¯æŒ**åˆ†å¸ƒå¼éƒ¨ç½²**ä¸**åŠ¨æ€æ°´å¹³æ‰©å±• (Vertical & Horizontal Scaling)**ï¼Œè¿™æ˜¯å‰åç«¯åˆ†ç¦»æ¶æ„å¸¦æ¥çš„æ ¸å¿ƒä¼˜åŠ¿ã€‚

### 1. åŠ¨æ€è°ƒæ•´ç®—åŠ› (Scale Up/Down)
ä½ å¯ä»¥é€šè¿‡ç®€å•çš„é…ç½®ï¼Œç¬é—´å¯åŠ¨å‡ åä¸ª Worker å¹¶è¡Œå¤„ç†æµ·é‡ä»»åŠ¡ï¼š

```bash
# ä¿®æ”¹ scripts/start_unified_worker.sh æˆ–é€šè¿‡ç¯å¢ƒå˜é‡
export WORKER_COUNT=10  # å¯åŠ¨ 10 ä¸ªå·¥å…µ
./scripts/start_unified_worker.sh
```

### 2. å¤šæœºåˆ†å¸ƒå¼é›†ç¾¤ (Distributed Cluster)
Worker ä¸å¿…å’Œ API è·‘åœ¨åŒä¸€å°æœºå™¨ä¸Šï¼ä½ å¯ä»¥åœ¨å¤šå° GPU æœåŠ¡å™¨ä¸Šè¿è¡Œ Workerï¼Œåªè¦å®ƒä»¬è¿æ¥åˆ°åŒä¸€ä¸ª Redisï¼š

*   **æœåŠ¡å™¨ A (API)**: åªè¿è¡Œ `uvicorn`ï¼Œè´Ÿè´£å¿«é€Ÿå“åº”ç”¨æˆ·è¯·æ±‚ã€‚
*   **æœåŠ¡å™¨ B (GPU)**: è¿è¡Œ `scripts/start_unified_worker.sh`ï¼Œè¿æ¥åˆ° A çš„ Redisã€‚
*   **æœåŠ¡å™¨ C (GPU)**: è¿è¡Œ `scripts/start_unified_worker.sh`ï¼Œè¿æ¥åˆ° A çš„ Redisã€‚

è¿™ç§æ¶æ„å…è®¸ä½ éšç€ä¸šåŠ¡å¢é•¿ï¼Œæ— é™æ·»åŠ è®¡ç®—èŠ‚ç‚¹ï¼Œè€Œæ— éœ€ä¿®æ”¹ä¸€è¡Œä»£ç ã€‚

## ğŸ“¦ é¡¹ç›®ç»“æ„

```
ASR_server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ asr/              # ASR æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ config.py     # é…ç½®ç®¡ç†
â”‚   â”‚   â””â”€â”€ recognizer.py # è¯†åˆ«å¼•æ“
â”‚   â”œâ”€â”€ api/              # FastAPI æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ main.py       # åº”ç”¨å…¥å£
â”‚   â”‚   â”œâ”€â”€ routes.py     # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ models.py     # æ•°æ®æ¨¡å‹
â”‚   â”‚   â””â”€â”€ dependencies.py
â”‚   â”œâ”€â”€ utils/            # å·¥å…·æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ redis_client.py
â”‚   â”‚   â”œâ”€â”€ streams.py    # Redis Streams
â”‚   â”‚   â”œâ”€â”€ file_handler.py
â”‚   â”‚   â””â”€â”€ logger.py
â”‚   â”œâ”€â”€ worker/
â”‚   â”‚   â””â”€â”€ unified_worker.py # ç»Ÿä¸€æ¶ˆè´¹è€…
â”‚   â””â”€â”€ storage/          # æ•°æ®å­˜å‚¨
â”‚       â”œâ”€â”€ recordings/   # éŸ³é¢‘æ–‡ä»¶
â”‚       â””â”€â”€ logs/         # æ—¥å¿—æ–‡ä»¶
â”œâ”€â”€ scripts/              # è¾…åŠ©è„šæœ¬
â”‚   â”œâ”€â”€ start_unified_worker.sh
â”‚   â””â”€â”€ clear_old_files.py
â”œâ”€â”€ tests/                # æµ‹è¯•
â”‚   â””â”€â”€ test_api.py
â””â”€â”€ STARTUP_GUIDE.md      # å¯åŠ¨æŒ‡å—
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

æœ¬é¡¹ç›®ä½¿ç”¨ `uv` è¿›è¡Œä¾èµ–ç®¡ç†ï¼Œå¹¶å·²é…ç½®ä¸ºä½¿ç”¨ **PyTorch Stable (2.7.0+)** ä»¥æ”¯æŒæœ€æ–°çš„ NVIDIA æ˜¾å¡ (Blackwell/CUDA 12.8)ã€‚

```bash
uv sync
```

### 2. å¯åŠ¨æœåŠ¡ (3 ä¸ªç»ˆç«¯)

```bash
# ç»ˆç«¯ 1: å¯åŠ¨ Redis
redis-server

# ç»ˆç«¯ 2: å¯åŠ¨ Workers
./scripts/start_unified_worker.sh

# ç»ˆç«¯ 3: å¯åŠ¨ API æœåŠ¡
uvicorn src.api.main:app --reload --port 8000
```

### 3. æµ‹è¯•

è®¿é—® http://localhost:8000/docs æŸ¥çœ‹ API æ–‡æ¡£

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8000/api/v1/health

# æäº¤ä»»åŠ¡
curl -X POST http://localhost:8000/api/v1/asr/submit \
  -F "audio=@test.wav"

# è¿è¡Œå•å…ƒæµ‹è¯•
pytest tests/test_api.py -v
```

## ğŸ“– å®Œæ•´æ–‡æ¡£

- [STARTUP_GUIDE.md](STARTUP_GUIDE.md) - è¯¦ç»†å¯åŠ¨å’Œæµ‹è¯•æŒ‡å—
- [ARCHITECTURE_DESIGN.md](report/ARCHITECTURE_DESIGN.md) - å®Œæ•´æ¶æ„è®¾è®¡

## ğŸ”Œ API ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/api/v1/asr/submit` | POST | æäº¤è½¬å½•ä»»åŠ¡ |
| `/api/v1/asr/result/{task_id}` | GET | æŸ¥è¯¢ä»»åŠ¡ç»“æœ |
| `/api/v1/health` | GET | å¥åº·æ£€æŸ¥ |
| `/api/v1/asr/history` | GET | è·å–å†å²è®°å½• |
| `/api/v1/asr/audio/{task_id}` | GET | ä¸‹è½½éŸ³é¢‘ |
| `/api/v1/asr/queue/status` | GET | é˜Ÿåˆ—çŠ¶æ€ |
| `/api/v1/asr/retry/{task_id}` | POST | é‡è¯•ä»»åŠ¡ |
| `/api/v1/asr/task/{task_id}` | DELETE | åˆ é™¤ä»»åŠ¡ |
| `/api/v1/stats` | GET | ç³»ç»Ÿç»Ÿè®¡ |

## âš™ï¸ ç¯å¢ƒå˜é‡

å¤åˆ¶ `.env.example` åˆ° `.env` å¹¶æ ¹æ®éœ€è¦ä¿®æ”¹ï¼š

```bash
cp .env.example .env
```

ä¸»è¦é…ç½®:
- `REDIS_HOST` - Redis ä¸»æœº (é»˜è®¤: localhost)
- `ASR_USE_GPU` - æ˜¯å¦ä½¿ç”¨ GPU (é»˜è®¤: true)
- `ASR_BATCH_SIZE` - æ‰¹å¤„ç†å¤§å° (é»˜è®¤: 500)
- `MAX_RECORDINGS` - æœ€å¤§ä¿ç•™å½•éŸ³æ•° (é»˜è®¤: 10)

## ğŸ§ª æµ‹è¯•æŒ‡å—

æœ¬é¡¹ç›®åŒ…å«ä¸€å¥—å®Œæ•´çš„æµ‹è¯•ç³»ç»Ÿï¼Œæ¶µç›–å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’Œæ€§èƒ½è´Ÿè½½æµ‹è¯•ã€‚

### 1. æµ‹è¯•ç»“æ„
```text
tests/
â”œâ”€â”€ unit/           # å•å…ƒæµ‹è¯• (Recognizer, FileHandler, RedisClient)
â”œâ”€â”€ integration/    # API é›†æˆæµ‹è¯•
â”œâ”€â”€ performance/    # è´Ÿè½½æµ‹è¯•ä¸èµ„æºç›‘æ§è„šæœ¬
â”œâ”€â”€ resources/      # æµ‹è¯•ç”¨éŸ³é¢‘æ–‡ä»¶
â””â”€â”€ conftest.py     # å…±äº« Fixtures
```

### 2. è¿è¡Œå¸¸è§„æµ‹è¯•
è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ï¼š
```bash
./scripts/run_tests.sh
```

### 3. é«˜å¹¶å‘è´Ÿè½½æµ‹è¯•
ç”¨äºéªŒè¯ç³»ç»Ÿåœ¨é«˜å¹¶å‘ä¸‹çš„ç¨³å®šæ€§ä¸æ€§èƒ½ã€‚

> [!IMPORTANT]
> **è¿è¡Œå‰å¿…è¯»**ï¼šè´Ÿè½½æµ‹è¯•éœ€è¦å®Œæ•´çš„åç«¯æœåŠ¡æ”¯æŒã€‚è¯·ç¡®ä¿ï¼š
> 1. Redis æœåŠ¡å·²å¯åŠ¨ (`redis-server`)
> 2. Worker å·²å¯åŠ¨ (`./scripts/start_unified_worker.sh`)
> 3. API æœåŠ¡è¿è¡Œä¸­ (`uvicorn src.api.main:app`)

**å‰ç½®æ¡ä»¶**: ç¡®ä¿ API æœåŠ¡å·²å¯åŠ¨ (`uvicorn src.api.main:app`)ã€‚

```bash
# ç”¨æ³•: ./scripts/run_load_test.sh [å¹¶å‘æ•°] [æŒç»­ç§’æ•°]
./scripts/run_load_test.sh 10 60
```

### 4. å®æ—¶å¯è§†åŒ–ä»ªè¡¨ç›˜
åœ¨è¿è¡Œè´Ÿè½½æµ‹è¯•æ—¶ï¼Œè®¿é—®ç³»ç»Ÿå†…ç½®çš„ä»ªè¡¨ç›˜æŸ¥çœ‹å®æ—¶æ•°æ®ï¼š
- **åœ°å€**: [http://localhost:8000/dashboard](http://localhost:8000/dashboard)
- **ç›‘æ§æŒ‡æ ‡**:
    - ğŸ“ˆ **èµ„æº**: CPU ä½¿ç”¨ç‡, å†…å­˜å ç”¨çš„å®æ—¶æ›²çº¿
    - ğŸ“‰ **é˜Ÿåˆ—**: å¾…å¤„ç†ä»»åŠ¡æ•° (Queue Depth), æ´»è·ƒ Worker æ•°
    - â±ï¸ **æ€§èƒ½**: è¯·æ±‚å»¶è¿Ÿ (Latency), ååé‡ (Throughput)

## ğŸ“Š ç›‘æ§

```bash
# æŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€
redis-cli XINFO STREAM asr_tasks

# æŸ¥çœ‹å¾…å¤„ç†
redis-cli XPENDING asr_tasks asr_workers

# æŸ¥çœ‹æ—¥å¿—
tail -f src/storage/logs/asr_api.log
tail -f src/storage/logs/asr_worker.log
```

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **Web æ¡†æ¶**: FastAPI 0.115.0
- **ASGI æœåŠ¡å™¨**: Uvicorn 0.32.0
- **ä»»åŠ¡é˜Ÿåˆ—**: Redis Streams (Consumer Groups)
- **æ¶ˆæ¯å­˜å‚¨**: Redis 5.0.14 (Windows Native)
- **ASR å¼•æ“**: FunASR (ModelScope)
- **æ·±åº¦å­¦ä¹ **: PyTorch 2.7.0

## ğŸ“„ è®¸å¯è¯

MIT

---

**Version**: 1.0.0
**Last Updated**: 2025-12-11
