# 后端监控架构学习笔记

**日期**: 2025-12-14
**主题**: Redis Streams 监控、心跳机制与云原生监控概念

---

## 1. Redis Worker 存活检测：XINFO vs 心跳机制

在讨论如何监控 Python Worker 是否存活时，我们对比了两种方案。

### 1.1 方案 B：基于 XINFO 的被动监控 (不推荐)

*   **原理**: 使用 Redis 的自省命令 `XINFO CONSUMERS` 查看消费者组状态。
*   **核心指标**: `idle` (空闲时间) —— 距离上一次处理消息过去了多久。
*   **误判逻辑**:
    *   监控系统发现 Worker 的 `idle` 时间很长（如 2 小时）。
    *   **无法区分**: 是 "Worker 挂了" 还是 "根本没有任务处理"。
    *   **比喻**: 就像通过查 "访客登记簿" 来判断保安是否在岗。如果 2 小时没人来登记，不能说明保安不在，可能只是没人来访问。
*   **适用场景**: 无法修改 Worker 源码的 "黑盒" 系统，或者是 "懒人模式"。

### 1.2 方案 A：基于心跳的主动监控 (业界标准)

*   **原理**: Worker 主动定期向 Redis 汇报状态。
*   **核心逻辑**:
    *   Worker 每隔固定时间（如 15s）写入一个带有 TTL（过期时间）的 Key。
    *   监控端检查这个 Key 是否存在。
*   **准确性**: 绝对准确。只要 Key 消失，说明 Worker 肯定出了问题（挂了或卡死）。
*   **比喻**: 给保安配对讲机，每 15 分钟报一次平安。不报就是出事了。
*   **结论**: **这是生产环境的业界标准方案。**

---

## 2. 云原生监控概念解析

### 2.1 CNCF (Cloud Native Computing Foundation)
*   **含义**: 云原生计算基金会。
*   **"毕业项目"**: 指像 Prometheus 这样已经非常成熟、稳定，被大厂广泛使用的开源项目。代表了**行业标准**。

### 2.2 Prometheus (普罗米修斯)
*   **误区**: 必须依赖 Kubernetes (K8s) 才能用？ -> **❌ 错误**。
*   **真相**: 它只是一个二进制程序，可以在单机 Linux、Docker 或树莓派上运行。它和 K8s 是 "米其林餐厅" 和 "巴黎" 的关系（经常一起出现，但可以独立存在）。
*   **核心能力**: **时序数据库 (TSDB)**。
    *   专门存储 "带时间戳的数字" (如: 10:00 CPU=20%, 10:01 CPU=25%)。
    *   相比 MySQL，它存取监控数据的速度极快。

### 2.3 生态组件
*   **PromQL**: Prometheus 的查询语言，能做复杂的数学运算（如计算 "过去 1 小时 99% 的请求延迟"）。
*   **Grafana**: **颜值担当**。负责把 Prometheus 的枯燥数据变成酷炫的仪表盘（折线图、热力图）。
*   **AlertManager**: **报警员**。负责根据规则发送报警（邮件、钉钉等）。

---

## 3. 非 K8s 环境下的监控部署

在单机 Linux 环境下，完全可以轻量级部署这套标准监控：

1.  **Go Backend**: 集成 Prometheus Go 客户端库，暴露 `/metrics` 接口。
2.  **Redis**: 运行 `redis_exporter` 二进制文件，转换 Redis 指标。
3.  **Python Worker**: 运行简易 HTTP Server 暴露指标。
4.  **Prometheus Server**: 使用 Docker 运行，配置抓取上述接口。

**结论**: 不需要上 K8s 也能享受顶级的监控体验。
