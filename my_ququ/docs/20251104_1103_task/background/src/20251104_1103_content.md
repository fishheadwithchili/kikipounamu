# Background: 本地录音保留与长录音分段处理

**版本**: 1.0  
**更新时间**: 2025-11-04 11:03:18

---

## 问题背景

### 现存问题

1. **录音丢失问题**
   - 当前录音保存在 C 盘临时文件夹
   - 转换失败后录音被删除，无法追溯
   - 无法手动重试或分析失败原因

2. **内存占用问题**
   - 长时间录音一次性处理内存占用过大
   - FunASR 处理长录音时可能导致性能问题
   - 没有分段处理机制

---

## 问题拆解

### 第一层：录音文件管理
- 录音存储位置选择（临时目录 vs 项目目录 vs 用户数据目录）
- 录音文件命名规范
- 录音数量限制和清理机制
- 与数据库记录的关联关系

### 第二层：长录音处理
- 录音时长检测
- 音频分段策略（静音点切分 vs 严格时长切分）
- 分段转换流程
- 文本结果拼接

### 第三层：用户体验
- 分段处理进度显示
- 失败时的提示信息
- 录音回放功能需求
- 历史记录界面调整

---

## 考虑过的方案

### 方案 A：保留在临时目录 + 数据库记录路径
**优点**：
- 不占用项目空间
- 符合临时文件的使用习惯

**缺点**：
- 临时文件可能被系统清理
- 无法保证长期可用性
- 跨设备同步困难

### 方案 B：保存到用户数据目录
**优点**：
- 使用 Electron 标准路径
- 不同设备独立管理
- 不会被误删

**缺点**：
- 用户不容易找到文件位置
- 需要额外的"打开文件夹"功能

### 方案 C：保存到项目目录（✅ 最终选择）
**优点**：
- 用户容易找到
- 便于手动管理
- 可以通过 Git 忽略规则排除

**缺点**：
- 占用项目空间
- 需要手动清理机制

---

### 分段策略对比

### 方案 A：在静音点切分
**优点**：
- 不会切断句子
- 转换质量更高

**缺点**：
- 实现复杂，需要 VAD 检测
- 静音点可能不存在（持续说话）
- 处理时间更长

### 方案 B：严格按时长切分（✅ 最终选择）
**优点**：
- 实现简单
- 处理速度快
- 切分位置可预测

**缺点**：
- 可能切断句子
- 转换质量略有下降

**理由**：语音转文本本身就有失误率，切断句子的影响可以接受（"虱子多了不怕痒"）

---

## 最终决策

### 1. 本地录音保留机制
- **存储位置**：项目根目录 `recordings/`
- **文件命名**：`YYYYMMDD_HHMM_recording.wav`（时间戳格式）
- **数量限制**：只保留最近 10 条录音
- **清理策略**：每次保存新录音时，自动删除最旧的（如果超过 10 条）
- **数据库关联**：可选，不强制关联（录音独立管理）

### 2. 长录音分段处理
- **时长检测**：录音完成后检测音频文件时长
- **分段策略**：超过 3 分钟（180 秒）严格按 3 分钟切分
- **分段处理**：
  - 使用 FFmpeg 或音频库分割音频
  - 每段独立调用 FunASR 转换
  - 按顺序拼接所有文本结果
- **进度显示**：界面显示"正在处理第 2/5 段"

### 3. 失败处理优化
- **失败提示**：界面显示"录音已保存，可在历史记录中查看"
- **文件保留**：无论转换成功与否，录音都保存到本地
- **手动处理**：用户可以手动打开录音文件重试

### 4. 不包含的功能
- **录音回放**：不在应用内添加播放功能，用户需要时手动打开文件

---

## 关键技术要求

### 录音文件管理
- 文件系统操作：创建目录、保存文件、删除旧文件
- 文件时间排序和数量管理
- 路径处理：项目根目录拼接

### 音频分段处理
- 音频时长检测（使用 librosa 或 FFmpeg）
- 音频分割（FFmpeg `-ss` 和 `-t` 参数）
- 临时文件管理（分段后的临时音频文件）

### 转换流程调整
- 检测音频时长
- 判断是否需要分段
- 循环处理每一段
- 拼接所有文本结果
- 更新进度状态

### 用户界面调整
- 分段处理进度显示组件
- 失败提示信息调整
- 历史记录界面提示（录音位置）

---

## 技术栈要求

- **Node.js**：文件系统操作（fs, path）
- **FFmpeg**：音频分割和时长检测（已预装）
- **FunASR**：分段转换（现有功能）
- **React**：进度显示 UI 组件

---

## 风险评估

### 1. 磁盘空间占用
**风险**：10 条 WAV 录音文件可能占用较大空间  
**缓解**：限制数量为 10，自动清理机制

### 2. 分段切分质量
**风险**：严格切分可能切断句子  
**缓解**：可接受（语音转文本本身有误差）

### 3. 分段处理时间
**风险**：长录音分段处理总时间可能更长  
**缓解**：进度显示让用户了解进度

### 4. FFmpeg 分割精度
**风险**：FFmpeg 分割可能不够精确（关键帧对齐）  
**缓解**：使用 `-c copy` 避免重新编码，或使用精确分割参数

---

## 后续考虑

- 是否需要配置项（录音保留数量、分段时长）
- 是否需要"清空所有录音"功能
- 是否需要录音文件大小限制
- 是否需要录音回放功能（未来可能添加）

