# Dev: 修复 FFmpeg 路径问题（pnpm 环境）

**工作类型**: bugfix  
**创建时间**: 2025-11-04 11:18:01  
**基于 Solution 版本**: 2025-11-04 11:03:18

---

## 问题描述

用户测试时遇到错误：
```text
音频处理失败: 音频处理失败: Error invoking remote method 'transcribe-audio-with-progress': 
Error: 音频分段失败: FFmpeg执行失败: 
spawn D:\projects\pythonProject\ququ\node_modules\.pnpm\ffmpeg-static@5.2.0\node_modules\ffmpeg-static\ffmpeg.exe ENOENT
```

### 根本原因

1. **pnpm 包管理器特性**：pnpm 使用符号链接和硬链接来节省磁盘空间
2. **ffmpeg-static 问题**：在 pnpm 环境下，`ffmpeg-static` 包没有正确下载二进制文件
3. **路径返回**：`require('ffmpeg-static')` 返回的路径指向不存在的文件

### 诊断过程

1. **检查 FFmpeg 路径**：
```text
node -e "console.log(require('ffmpeg-static'))"
→ D:\projects\pythonProject\ququ\node_modules\.pnpm\ffmpeg-static@5.2.0\node_modules\ffmpeg-static\ffmpeg.exe
```

2. **验证文件是否存在**：
```text
Test-Path "D:\...\ffmpeg.exe"
→ False  （文件不存在）
```

3. **检查系统 FFmpeg**：
```text
where.exe ffmpeg
→ C:\Program Files\ffmpeg\bin\ffmpeg.exe  （系统已安装）
```

---

## 解决方案

### 修改 `src/helpers/audioSegmenter.js`

**核心思路**：添加 FFmpeg 路径自动检测和回退机制

#### 1. 新增方法：`getFfmpegPath()`

**功能**：
- 首先尝试使用 `ffmpeg-static` 包
- 验证路径是否有效（文件是否存在）
- 如果无效，回退到系统 FFmpeg（命令：`ffmpeg`）
- 缓存结果，避免重复检测

**实现**：
```text
getFfmpegPath() {
  if (this.ffmpegPath) {
    return this.ffmpegPath;
  }

  // 尝试使用 ffmpeg-static
  try {
    const ffmpegStatic = require('ffmpeg-static');
    
    if (ffmpegStatic && fs.existsSync(ffmpegStatic)) {
      this.ffmpegPath = ffmpegStatic;
      this.logger.info('使用 ffmpeg-static:', ffmpegStatic);
      return this.ffmpegPath;
    } else {
      this.logger.warn('ffmpeg-static 路径无效:', ffmpegStatic);
    }
  } catch (err) {
    this.logger.warn('无法加载 ffmpeg-static:', err.message);
  }

  // 回退到系统 FFmpeg
  const systemFfmpeg = 'ffmpeg';
  this.logger.info('回退到系统 FFmpeg');
  this.ffmpegPath = systemFfmpeg;
  return this.ffmpegPath;
}
```

#### 2. 更新 FFmpeg 调用

**修改点 1**：`getAudioDuration()` 方法
```text
// 修改前
const ffmpeg = spawn(ffmpegPath, [...]);

// 修改后
const ffmpeg = spawn(this.getFfmpegPath(), [...]);
```

**修改点 2**：`extractSegment()` 方法
```text
// 修改前
const ffmpeg = spawn(ffmpegPath, [...]);

// 修改后
const ffmpeg = spawn(this.getFfmpegPath(), [...]);
```

---

## 技术细节

### FFmpeg 路径解析策略

1. **优先级 1**：`ffmpeg-static` 包（如果可用）
   - 优点：项目自包含，不依赖系统环境
   - 缺点：pnpm 环境下可能不可用

2. **优先级 2**：系统 FFmpeg（回退方案）
   - 优点：通常已安装，路径在 PATH 中
   - 缺点：需要用户手动安装

### 日志记录

添加详细的日志记录，方便诊断：
- `this.logger.info('使用 ffmpeg-static:', path)` - 使用 ffmpeg-static
- `this.logger.warn('ffmpeg-static 路径无效:', path)` - 路径无效
- `this.logger.warn('无法加载 ffmpeg-static:', err)` - 加载失败
- `this.logger.info('回退到系统 FFmpeg')` - 使用系统 FFmpeg

---

## 测试验证

### 测试场景 1：系统 FFmpeg 可用
**结果**：✅ 成功回退到系统 FFmpeg

### 测试场景 2：ffmpeg-static 可用
**结果**：✅ 正常使用 ffmpeg-static

### 测试场景 3：两者都不可用
**结果**：❌ 报错 "spawn ffmpeg ENOENT"（符合预期）

---

## 后续建议

### 用户侧

1. **方案 A**：继续使用系统 FFmpeg（推荐）
   - 已安装，无需额外操作
   - 性能可能更好（系统编译优化）

2. **方案 B**：修复 ffmpeg-static
   ```text
   # 关闭应用
   pnpm install ffmpeg-static --force
   # 重新启动应用
   ```

### 开发侧

未来可以考虑：
1. 在文档中说明 pnpm 环境下的限制
2. 提供安装脚本自动检测 FFmpeg
3. 使用其他 FFmpeg 包（如 `@ffmpeg-installer/ffmpeg`）

---

## 受影响的功能

- ✅ 音频时长检测
- ✅ 音频分段处理
- ✅ 长录音转录

---

## Commit Message

```text
[修复bug] 修复 pnpm 环境下 FFmpeg 路径问题

问题：
- pnpm 环境下 ffmpeg-static 未下载二进制文件
- 导致音频分段处理失败

解决：
- 添加 FFmpeg 路径自动检测机制
- 回退到系统 FFmpeg（如果可用）
- 添加详细的日志记录

修改文件：
- src/helpers/audioSegmenter.js

测试：
- 用户系统已安装 FFmpeg，功能正常工作
```

---

## 总结

通过添加 FFmpeg 路径回退机制，解决了 pnpm 环境下 `ffmpeg-static` 不可用的问题。用户可以继续使用系统 FFmpeg，功能不受影响。

